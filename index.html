<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reliability Tests</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: #eef5ff;
    }
    header {
      background: linear-gradient(to right, #2193b0, #6dd5ed);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }
    #container {
      padding: 30px;
      max-width: 1000px;
      margin: auto;
    }
    input[type="file"] {
      margin-bottom: 20px;
    }
    #alpha-box {
      border: 3px solid #0077cc;
      background-color: #ffffff;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #0a1f44;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 3px 3px 8px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      background-color: #fff;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
      font-size: 15px;
    }
    th {
      background-color: #d0e8ff;
      font-weight: bold;
    }
    .note {
      font-size: 13px;
      color: #444;
      margin-top: 10px;
    }
    h3 {
      color: #0077cc;
      margin-bottom: 10px;
    }
    .footnote {
      font-size: 13px;
      margin-top: -15px;
      margin-bottom: 20px;
      color: #444;
    }
  </style>
</head>
<body>
  <header>
    Reliability Tests<br>
    Developed by Dr. Mazen Badawy â€“ Doctorate of TEFL
  </header>
  <div id="container">
    <input type="file" id="fileInput" accept=".xlsx, .xls">
    <div id="alpha-box"></div>
    <div id="output-table"></div>
    <div id="correlation-matrix"></div>
  </div>

  <script>
    document.getElementById('fileInput').addEventListener('change', handleUpload);

    function handleUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const headers = json[0];
        const rows = json.slice(1).filter(row => row.length === headers.length);
        const items = rows.map(row => row.map(Number));

        const part1 = items.map(row => row.slice(0, row.length / 2));
        const part2 = items.map(row => row.slice(row.length / 2));

        function mean(arr) {
          return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        function variance(arr) {
          const m = mean(arr);
          return mean(arr.map(x => (x - m) ** 2));
        }

        function cronbachAlpha(matrix) {
          const k = matrix[0].length;
          const itemVars = matrix[0].map((_, i) => variance(matrix.map(row => row[i])));
          const totalVar = variance(matrix.map(row => row.reduce((a, b) => a + b, 0)));
          return (k / (k - 1)) * (1 - (itemVars.reduce((a, b) => a + b, 0) / totalVar));
        }

        function correlation(x, y) {
          const n = x.length;
          const mx = mean(x), my = mean(y);
          const cov = x.reduce((sum, xi, i) => sum + (xi - mx) * (y[i] - my), 0) / n;
          const sx = Math.sqrt(variance(x));
          const sy = Math.sqrt(variance(y));
          return cov / (sx * sy);
        }

        const part1Scores = part1.map(row => row.reduce((a, b) => a + b, 0));
        const part2Scores = part2.map(row => row.reduce((a, b) => a + b, 0));

        const alpha1 = cronbachAlpha(part1);
        const alpha2 = cronbachAlpha(part2);
        const totalAlpha = cronbachAlpha(items);
        const r = correlation(part1Scores, part2Scores);
        const k = part1[0].length / part2[0].length;
        const sbEqual = (2 * r) / (1 + r);
        const sbUnequal = (k * r) / (1 + (k - 1) * r);
        const guttman = r;

        document.getElementById("alpha-box").innerHTML =
          `Cronbach's Alpha (Total): <strong>${totalAlpha.toFixed(4)}</strong>`;

        const tableHTML = `
          <table>
            <tr><th colspan="3">Correlation Between Forms</th></tr>
            <tr><td><strong>Cronbach's Alpha</strong></td><td>Part 1</td><td>${alpha1.toFixed(4)}</td></tr>
            <tr><td></td><td>N of Items</td><td>${part1[0].length}</td></tr>
            <tr><td></td><td>Part 2</td><td>${alpha2.toFixed(4)}</td></tr>
            <tr><td></td><td>N of Items</td><td>${part2[0].length}</td></tr>
            <tr><td colspan="2"><strong>Total N of Items</strong></td><td>${items[0].length}</td></tr>
            <tr><td colspan="2">Correlation Between Forms</td><td>${r.toFixed(3)}</td></tr>
            <tr><td rowspan="2">Spearman-Brown Coefficient</td><td>Equal Length</td><td>${sbEqual.toFixed(3)}</td></tr>
            <tr><td>Unequal Length</td><td>${sbUnequal.toFixed(3)}</td></tr>
            <tr><td colspan="2"><strong>Guttman Split-Half Coefficient</strong></td><td><strong>${guttman.toFixed(3)}</strong></td></tr>
          </table>
          <div class="note">a. The value may be negative due to negative average covariance. Check item codings.</div>
        `;

        document.getElementById("output-table").innerHTML = tableHTML;

        // Generate Inter-Item Correlation Matrix with significance
        const corrMatrix = headers.map((_, i) =>
          headers.map((_, j) => {
            const col1 = items.map(row => row[i]);
            const col2 = items.map(row => row[j]);
            const r = correlation(col1, col2);
            const df = col1.length - 2;
            const t = Math.abs(r) * Math.sqrt(df / (1 - r ** 2));
            const p = tDistributionPValue(t, df);
            let asterisk = '';
            if (p < 0.01) asterisk = '**';
            else if (p < 0.05) asterisk = '*';
            return r.toFixed(3) + asterisk;
          })
        );

        let corrTable = "<h3>Inter-item Correlation Matrix</h3><table><tr><th></th>";
        headers.forEach(h => corrTable += `<th>${h}</th>`);
        corrTable += "</tr>";

        corrMatrix.forEach((row, i) => {
          corrTable += `<tr><th>${headers[i]}</th>`;
          row.forEach(val => corrTable += `<td>${val}</td>`);
          corrTable += "</tr>";
        });

        corrTable += "</table>";
        corrTable += `<div class="footnote">
          * Correlation is significant at the 0.05 level (2-tailed).<br>
          ** Correlation is significant at the 0.01 level (2-tailed).
        </div>`;
        document.getElementById("correlation-matrix").innerHTML = corrTable;
      };
      reader.readAsArrayBuffer(file);
    }

    // Approximate p-value from t and df using survival function of t-distribution
    function tDistributionPValue(t, df) {
      function gamma(x) {
        if (x < 0.5) return Math.PI / (Math.sin(Math.PI * x) * gamma(1 - x));
        x -= 1;
        let a = 1, p = [1, 0.5772156649, -0.6558780715, -0.042002635, 0.1665386114];
        for (let i = 0; i < p.length; ++i) a += p[i] / (x + i + 1);
        return Math.sqrt(2 * Math.PI) * Math.pow(x + 1.5, x + 0.5) * Math.exp(-(x + 1.5)) * a;
      }

      function betaIncomplete(x, a, b) {
        let bt = Math.exp(gamma(a + b) - gamma(a) - gamma(b) + a * Math.log(x) + b * Math.log(1 - x));
        return bt;
      }

      const x = df / (df + t ** 2);
      return 2 * (1 - betaIncomplete(x, df / 2, 0.5));
    }
  </script>
</body>
</html>
