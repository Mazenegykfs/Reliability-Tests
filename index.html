<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reliability Tests</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #e8f0fe;
      color: #0a1f44;
      margin: 20px;
    }
    h2, h3 {
      color: #1a73e8;
    }
    #logo {
      position: absolute;
      top: 20px;
      right: 20px;
      height: 80px;
    }
    #output-wrapper {
      margin-top: 20px;
      padding: 10px;
      background-color: #f1f8ff;
      border: 1px solid #c6dafc;
      border-radius: 8px;
    }
    .alpha-box {
      border: 2px solid #1a73e8;
      background-color: #ffffff;
      padding: 10px;
      margin-bottom: 10px;
      font-weight: bold;
      color: #0a1f44;
      border-radius: 8px;
      box-shadow: 2px 2px 6px #c6dafc;
    }
    #reliability-summary {
      white-space: pre-wrap;
      margin-top: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background-color: #ffffff;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #1a73e8;
    }
    th, td {
      padding: 8px;
      text-align: center;
      color: #0a1f44;
    }
    th {
      background-color: #d2e3fc;
    }
    .footer-note {
      font-size: 0.9em;
      color: #5f6368;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <img src="00.png" id="logo" alt="Logo">
  <h2>Reliability Tests</h2>
  <h3>Developed by Dr. Mazen Badawy â€“ Doctorate of TEFL</h3>
  <input type="file" id="upload" accept=".xlsx, .xls">
  <button onclick="exportToExcel()">Export to Excel</button>

  <div id="output-wrapper">
    <div id="alpha-box" class="alpha-box"></div>
    <div id="reliability-summary"></div>
  </div>

  <div id="matrix"></div>

  <div class="footer-note">
    * Correlation is significant at the 0.05 level (2-tailed).<br>
    ** Correlation is significant at the 0.01 level (2-tailed).
  </div>

  <script>
    let outputData = "";
    let matrixData = [];

    document.getElementById('upload').addEventListener('change', handleUpload);

    function readExcel(file, callback) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        callback(json);
      };
      reader.readAsArrayBuffer(file);
    }

    function calculateAlpha(matrix) {
      const n = matrix[0].length;
      const itemVariances = matrix[0].map((_, col) => {
        const scores = matrix.map(row => row[col]);
        const mean = scores.reduce((a, b) => a + b) / scores.length;
        return scores.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (scores.length - 1);
      });
      const totalScores = matrix.map(row => row.reduce((a, b) => a + b));
      const meanTotal = totalScores.reduce((a, b) => a + b) / totalScores.length;
      const varianceTotal = totalScores.reduce((sum, val) => sum + Math.pow(val - meanTotal, 2), 0) / (totalScores.length - 1);
      const sumItemVariances = itemVariances.reduce((a, b) => a + b);
      return (n / (n - 1)) * (1 - (sumItemVariances / varianceTotal));
    }

    function pearsonCorrelation(x, y) {
      const n = x.length;
      const meanX = x.reduce((a, b) => a + b) / n;
      const meanY = y.reduce((a, b) => a + b) / n;
      const numerator = x.reduce((sum, xi, i) => sum + (xi - meanX) * (y[i] - meanY), 0);
      const denominatorX = Math.sqrt(x.reduce((sum, xi) => sum + Math.pow(xi - meanX, 2), 0));
      const denominatorY = Math.sqrt(y.reduce((sum, yi) => sum + Math.pow(yi - meanY, 2), 0));
      return numerator / (denominatorX * denominatorY);
    }

    function calculateCorrelationMatrix(matrix) {
      const n = matrix[0].length;
      const correlationMatrix = Array(n).fill(0).map(() => Array(n).fill(0));
      for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {
          const xi = matrix.map(row => row[i]);
          const yj = matrix.map(row => row[j]);
          let corr = pearsonCorrelation(xi, yj);
          const formattedCorr = parseFloat(corr.toFixed(3));
          if (i !== j) {
            if (Math.abs(corr) >= 0.5) {
              correlationMatrix[i][j] = formattedCorr.toFixed(3) + "**";
            } else if (Math.abs(corr) >= 0.3) {
              correlationMatrix[i][j] = formattedCorr.toFixed(3) + "*";
            } else {
              correlationMatrix[i][j] = formattedCorr.toFixed(3);
            }
          } else {
            correlationMatrix[i][j] = formattedCorr.toFixed(3);
          }
        }
      }
      return correlationMatrix;
    }

    function handleUpload(e) {
      const file = e.target.files[0];
      readExcel(file, (data) => {
        const headers = data[0];
        const rows = data.slice(1).map(row => row.map(Number));
        const alpha = calculateAlpha(rows);

        const half = Math.floor(headers.length / 2);
        const left = rows.map(row => row.slice(0, half));
        const right = rows.map(row => row.slice(half));

        const leftSums = left.map(row => row.reduce((a, b) => a + b));
        const rightSums = right.map(row => row.reduce((a, b) => a + b));
        const r = pearsonCorrelation(leftSums, rightSums);
        const totalScores = rows.map(row => row.reduce((a, b) => a + b));

        const differences = leftSums.map((val, i) => val - rightSums[i]);
        const meanDiff = differences.reduce((a, b) => a + b, 0) / differences.length;
        const varianceDiff = differences.reduce((sum, val) => sum + Math.pow(val - meanDiff, 2), 0) / (differences.length - 1);
        const meanTotal = totalScores.reduce((a, b) => a + b, 0) / totalScores.length;
        const varianceTotal = totalScores.reduce((sum, val) => sum + Math.pow(val - meanTotal, 2), 0) / (totalScores.length - 1);
        const guttmanCoefficient = 1 - (varianceDiff / varianceTotal);

        outputData =
          "Cronbach's Alpha: " + alpha.toFixed(4) + "\n" +
          "Split-Half Reliability: " + r.toFixed(4) + "\n" +
          "Spearman-Brown (Equal Length): " + ((2 * r) / (1 + r)).toFixed(4) + "\n" +
          "Spearman-Brown (Unequal Length): " + (r / (1 - r)).toFixed(4) + "\n" +
          "Guttman Split-Half Coefficient: " + guttmanCoefficient.toFixed(4) + "\n";

        document.getElementById("alpha-box").innerHTML =
          `Cronbach's Alpha: ${alpha.toFixed(4)}`;

        document.getElementById("reliability-summary").innerText =
          "Split-Half Reliability: " + r.toFixed(4) + "\n" +
          "Spearman-Brown (Equal Length): " + ((2 * r) / (1 + r)).toFixed(4) + "\n" +
          "Spearman-Brown (Unequal Length): " + (r / (1 - r)).toFixed(4) + "\n" +
          "Guttman Split-Half Coefficient: " + guttmanCoefficient.toFixed(4);

        matrixData = calculateCorrelationMatrix(rows);

        let table = "<table><tr><th></th>";
        headers.forEach(h => table += "<th>" + h + "</th>");
        table += "</tr>";
        matrixData.forEach((row, i) => {
          table += "<tr><th>" + headers[i] + "</th>";
          row.forEach(cell => table += "<td>" + cell + "</td>");
          table += "</tr>";
        });
        table += "</table>";
        document.getElementById("matrix").innerHTML = table;
      });
    }

    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      const reliabilitySheet = outputData.trim().split("\n").map(line => [line]);
      const reliabilityWS = XLSX.utils.aoa_to_sheet(reliabilitySheet);
      const matrixWS = XLSX.utils.aoa_to_sheet([[""].concat(matrixData[0].map((_, i) => i + 1))].concat(matrixData.map((row, i) => [i + 1].concat(row))));
      XLSX.utils.book_append_sheet(wb, reliabilityWS, "Reliability");
      XLSX.utils.book_append_sheet(wb, matrixWS, "Correlation Matrix");
      XLSX.writeFile(wb, "Reliability Results.xlsx");
    }
  </script>
</body>
</html>
